"""
routing.py: defines services provided by the collection of protocols
"""
from typing import Tuple

import netaddr

from core.emane.nodes import EmaneNet
from core.emulator.enumerations import LinkTypes
from core.nodes.base import CoreNode
from core.nodes.interface import DEFAULT_MTU, CoreInterface
from core.nodes.network import PtpNet, WlanNode
from core.nodes.physical import Rj45Node
from core.services.coreservices import CoreService


def addrstr(ip: netaddr.IPNetwork) -> str:
  """
  helper for mapping IP addresses to config statements
  """
  address = str(ip.ip)
  if netaddr.valid_ipv4(address):
      return "ip address %s" % ip
  elif netaddr.valid_ipv6(address):
      return "ipv6 address %s" % ip
  else:
      raise ValueError("invalid address: %s", ip)

class Hello(CoreService):
  name: str = "ClientServer"
  group: str = "Networking"

  configs: Tuple[str, ...] = ("hello.conf", "helloboot.sh")

  startup: Tuple[str, ...] = ("bash helloboot.sh", )

  @classmethod
  def generate_config(cls, node: CoreNode, filename: str) -> None:
    if filename == cls.configs[0]:
      return cls.generate_hello_conf(node)
    elif filename == cls.configs[1]:
      return cls.generate_hello_boot()
    else:
      raise ValueError("file name (%s) is not a known configuration: %s",
                       filename, cls.configs)

  @classmethod
  def generate_hello_conf(cls, node: CoreNode) -> str:
    cfg = ""
    for iface in node.get_ifaces():
      cfg += "interface %s\n" % iface.name
      cfg += "\n".join(map(addrstr, iface.ip4s))
      cfg += "\n!\n"
    return cfg

  @classmethod
  def generate_hello_boot(cls) -> str:
    """
    Generate shell script used to boot the daemons
    """
    return """\
#!/bin/sh
# auto-generated by clientserver service (networking.py)

touch server.log
chmod 777 server.log
/home/ben/projects/routing/clientserver/build/server -d

touch client.log
chmod 777 client.log
/home/ben/projects/routing/clientserver/build/client -d

"""


class ARPMonitor(CoreService):
  name: str = "ARPMonitor"
  group: str = "Networking"

  configs: Tuple[str, ...] = ("monitorboot.sh", )

  startup: Tuple[str, ...] = ("bash monitorboot.sh", )

  @classmethod
  def generate_config(cls, node: CoreNode, filename: str) -> None:
    if filename == cls.configs[0]:
      return cls.generate_monitor_boot()
    else:
      raise ValueError("file name (%s) is not a known configuration: %s",
                       filename, cls.configs)

  @classmethod
  def generate_monitor_boot(cls) -> str:
    """
    Generate shell script used to boot the daemons
    """
    return """\
#!/bin/sh
# auto-generated by arp-monitor service (networking.py)

/home/ben/projects/routing/arp/build/arp-monitor -d

"""
